{% extends 'base.html' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h3>Productos</h3>
  <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#bulkAdd" aria-expanded="false" aria-controls="bulkAdd">
    <i class="bi bi-plus-lg me-1"></i> Añadir nuevos productos
  </button>
</div>

<div class="collapse mb-4 {% if preview_rows %}show{% endif %}" id="bulkAdd">
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">Paso 1: datos base y cantidad</h5>
  <form method="post" action="{{ url_for('main.products_admin_list') }}" class="row g-3" enctype="multipart/form-data">
        <input type="hidden" name="action" value="preview">
        <div class="col-12 col-lg-4">
          <label class="form-label">Nombre</label>
          <input type="text" class="form-control" name="name" placeholder="Ej: Mecha de acero" value="{{ (preview_rows and preview_rows[0].name) or '' }}" required>
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">SKU</label>
          <input type="text" class="form-control" name="sku" value="{{ (preview_rows and preview_rows[0].sku) or '' }}">
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">Precio</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input type="text" class="form-control" name="price" value="{{ (preview_rows and preview_rows[0].price) or '' }}" placeholder="0,00">
          </div>
        </div>
        <div class="col-6 col-lg-2 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="in_stock" id="base_in_stock" {% if not preview_rows or preview_rows[0].in_stock %}checked{% endif %}>
            <label class="form-check-label" for="base_in_stock"> En stock </label>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">Categoría</label>
          <select class="form-select" name="category_id">
            <option value="">- Sin categoría -</option>
            {% for root in roots %}
              {% set children = root.children|sort(attribute='name') %}
              {% if children %}
                <optgroup label="{{ root.name }}">
                  {% for sub in children %}
                    <option value="{{ sub.id }}" {% if preview_rows and preview_rows[0].category_id == sub.id|string %}selected{% endif %}>{{ sub.name }}</option>
                  {% endfor %}
                </optgroup>
              {% else %}
                <option value="{{ root.id }}" {% if preview_rows and preview_rows[0].category_id == root.id|string %}selected{% endif %}>{{ root.name }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-lg-2">
          <label class="form-label">Marca</label>
          <select class="form-select" name="brand_id">
            <option value="">- Sin marca -</option>
            {% for b in brands %}
              <option value="{{ b.id }}" {% if preview_rows and preview_rows[0].brand_id and (preview_rows[0].brand_id|string) == (b.id|string) %}selected{% endif %}>{{ b.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-lg-3">
          <label class="form-label">Multiplicar producto</label>
          <input type="number" min="1" max="200" step="1" class="form-control" name="quantity" value="{{ preview_rows and preview_rows|length or 1 }}">
          <div class="form-text">Se crearán X copias para editar individualmente en el próximo paso.</div>
        </div>
        <div class="col-12">
          <div class="alert alert-info py-2 small mb-0">Formato de precio: usar coma para decimales (ej: 1.234,50).</div>
        </div>
        <div class="col-12 d-flex justify-content-end">
          <button class="btn btn-primary" type="submit">Avanzar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if preview_rows %}
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">Paso 2: revisá y editá cada producto</h5>
  <form method="post" action="{{ url_for('main.products_admin_list') }}" enctype="multipart/form-data">
      <input type="hidden" name="action" value="save">
      <input type="hidden" name="items_count" value="{{ preview_rows|length }}">
      <div class="alert alert-info py-2 small">Formato de precio: utilizar coma para decimales (ej: 1.234,50).</div>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 40px"></th>
              <th>Nombre</th>
              <th>SKU</th>
              <th style="width: 130px">Precio</th>
              <th>Stock</th>
              <th>Marca</th>
              <th>Categoría</th>
              <th>Imagen</th>
              <th style="width: 140px">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for row in preview_rows %}
            {% set i = loop.index0 %}
            <tr>
              <td class="text-center">
                <input class="form-check-input" type="checkbox" name="items[{{ i }}][delete]">
              </td>
              <td>
                <input type="text" name="items[{{ i }}][name]" class="form-control" value="{{ row.name }}" required>
              </td>
              <td>
                <input type="text" name="items[{{ i }}][sku]" class="form-control" value="{{ row.sku }}">
              </td>
              <td>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="text" name="items[{{ i }}][price]" class="form-control" value="{{ row.price }}" placeholder="0,00">
                </div>
              </td>
              <td class="text-center">
                <input class="form-check-input" type="checkbox" name="items[{{ i }}][in_stock]" {% if row.in_stock %}checked{% endif %}>
              </td>
              <td>
                <select class="form-select" name="items[{{ i }}][brand_id]">
                  <option value="" {% if not row.brand_id %}selected{% endif %}>- Sin marca -</option>
                  {% for b in brands %}
                    <option value="{{ b.id }}" {% if row.brand_id and (row.brand_id|string) == (b.id|string) %}selected{% endif %}>{{ b.name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <select class="form-select" name="items[{{ i }}][category_id]">
                  <option value="" {% if not row.category_id %}selected{% endif %}>- Sin categoría -</option>
                  {% for root in roots %}
                    {% set children = root.children|sort(attribute='name') %}
                    {% if children %}
                      <optgroup label="{{ root.name }}">
                        {% for sub in children %}
                          <option value="{{ sub.id }}" {% if row.category_id and (row.category_id|string) == (sub.id|string) %}selected{% endif %}>{{ sub.name }}</option>
                        {% endfor %}
                      </optgroup>
                    {% else %}
                      <option value="{{ root.id }}" {% if row.category_id and (row.category_id|string) == (root.id|string) %}selected{% endif %}>{{ root.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </td>
              <td>
                <input type="file" name="image_{{ i }}" accept="image/*" class="form-control form-control-sm">
              </td>
              <td class="text-end">
                <a
                  class="btn btn-outline-primary btn-sm"
                  href="{{ url_for('main.products_admin_preview_edit', row_index=i) }}">
                  Edición completa
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.querySelectorAll('#bulkAdd tbody input[type=checkbox]').forEach(cb => cb.checked = true)">Seleccionar todos</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.querySelectorAll('#bulkAdd tbody input[type=checkbox]').forEach(cb => cb.checked = false)">Deseleccionar</button>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-danger" type="submit" name="delete_mode" value="selected" onclick="return confirm('¿Eliminar las filas seleccionadas del listado a crear?');">Eliminar seleccionados</button>
          <button class="btn btn-outline-danger" type="submit" name="delete_mode" value="all" onclick="return confirm('¿Eliminar todas las filas del listado a crear?');">Eliminar todo</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('main.products_admin_list', clear_preview=1) }}">Descartar cambios</a>
          <button class="btn btn-success" type="submit">Guardar y publicar</button>
        </div>
      </div>
    </form>
  </div>
 </div>
{% endif %}

<div class="card shadow-sm mb-4" id="excelUploadCard">
  <div class="card-body">
    <h5 class="card-title">Cargar productos desde Excel</h5>
    <p class="small text-muted mb-3">
      Seleccioná el archivo (.xlsx/.xls/.csv). El sistema buscará en la fila 1 las columnas <strong>B</strong> (Código) y <strong>C</strong> (Nombre) y enumerará los productos encontrados.
    </p>
    <div class="d-flex flex-column flex-sm-row gap-2 align-items-start mb-3">
      <input class="form-control" type="file" id="excelUploadInput" accept=".xlsx,.xls,.csv">
      <button class="btn btn-outline-primary" type="button" id="excelParseBtn">Cargar Excel</button>
    </div>
    <div id="excelControls" class="d-none mb-2">
      <button class="btn btn-sm btn-outline-secondary" type="button" id="excelSelectAll">Seleccionar todos</button>
      <button class="btn btn-sm btn-outline-secondary" type="button" id="excelDeselectAll">Deseleccionar todos</button>
    </div>
    <div id="excelResults" class="table-responsive d-none" style="max-height: 340px; overflow:auto;">
      <table class="table table-sm mb-0" id="excelResultsTable">
        <thead>
          <tr>
            <th style="width: 40px"></th>
            <th>Código</th>
            <th>Nombre</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="mt-3">
      <button class="btn btn-success" type="button" id="excelSendBtn" disabled>Enviar seleccionados a crear</button>
    </div>
  </div>
</div>

<form id="excelPreviewForm" method="post" action="{{ url_for('main.products_admin_list') }}">
  <input type="hidden" name="action" value="excel_preview">
  <input type="hidden" name="excel_payload" id="excelPayload">
</form>

<hr class="my-4">
<h4 class="mb-3">Buscar y Editar Productos</h4>

<form method="get" action="{{ url_for('main.products_admin_list') }}" class="row g-2 align-items-end mb-3">
  <div class="col-12 col-md-4">
    <label class="form-label">Búsqueda inteligente</label>
    <input type="text" class="form-control" name="q" value="{{ q or '' }}" placeholder="Nombre, descripción o código...">
  </div>
  <div class="col-6 col-md-3">
    <label class="form-label">Categoría</label>
    <select class="form-select" name="category_id">
      <option value="">Todas</option>
      {% for root in roots %}
        {% set children = root.children|sort(attribute='name') %}
        {% if children %}
          <optgroup label="{{ root.name }}">
            {% for sub in children %}
              <option value="{{ sub.id }}" {% if category_id and (category_id|string) == (sub.id|string) %}selected{% endif %}>{{ sub.name }}</option>
            {% endfor %}
          </optgroup>
        {% else %}
          <option value="{{ root.id }}" {% if category_id and (category_id|string) == (root.id|string) %}selected{% endif %}>{{ root.name }}</option>
        {% endif %}
      {% endfor %}
    </select>
  </div>
  <div class="col-6 col-md-3">
    <label class="form-label">Marca</label>
    <select class="form-select" name="brand_id">
      <option value="">Todas</option>
      {% for b in brands %}
        <option value="{{ b.id }}" {% if brand_id and (brand_id|string) == (b.id|string) %}selected{% endif %}>{{ b.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-6 col-md-2">
    <label class="form-label">Por página</label>
    <select class="form-select" name="per_page">
      {% for size in [20, 50, 100] %}
        <option value="{{ size }}" {% if per_page == size %}selected{% endif %}>{{ size }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12 col-md-2 mt-2 mt-md-0">
    <button class="btn btn-outline-primary w-100" type="submit">Filtrar</button>
  </div>
</form>

<form method="post" action="{{ url_for('main.products_admin_bulk_delete') }}">
  <input type="hidden" name="q" value="{{ q or '' }}">
  <input type="hidden" name="category_id" value="{{ category_id or '' }}">
  <input type="hidden" name="brand_id" value="{{ brand_id or '' }}">
  <input type="hidden" name="per_page" value="{{ per_page }}">
  <input type="hidden" name="page" value="{{ page }}">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="small text-muted">
      {% if total %}{{ total }} producto(s) encontrados{% endif %}
    </div>
    <div class="d-flex flex-wrap gap-2">
      <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.querySelectorAll('#productsTable tbody input[type=checkbox].row-select').forEach(cb => cb.checked = true)">Seleccionar todos</button>
      <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.querySelectorAll('#productsTable tbody input[type=checkbox].row-select').forEach(cb => cb.checked = false)">Deseleccionar</button>
      <button class="btn btn-danger btn-sm" type="submit" name="mode" value="selected" onclick="return confirm('¿Eliminar los productos seleccionados? Esta acción no se puede deshacer.');">Eliminar seleccionados</button>
      <button class="btn btn-outline-danger btn-sm" type="submit" name="mode" value="all" onclick="return confirm('¿Eliminar TODOS los productos que coinciden con la búsqueda actual? Esta acción no se puede deshacer.');">Eliminar todo</button>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('main.products_admin_list', q=q, category_id=category_id, brand_id=brand_id, per_page=per_page, page=page) }}">Descartar cambios</a>
      <button form="inlineEditForm" class="btn btn-primary btn-sm" type="submit">Guardar cambios</button>
    </div>
  </div>

  <div class="table-responsive shadow-sm rounded mb-2">
  <table class="table align-middle" id="productsTable">
    <thead class="table-light">
      <tr>
        <th style="width: 40px"></th>
        <th>Nombre</th>
        <th>SKU</th>
        <th>Precio</th>
        <th>Stock</th>
        <th>Marca</th>
        <th>Categoría</th>
        <th>Imagen</th>
        <th style="width: 160px"></th>
      </tr>
    </thead>
    <tbody>
    {% if products %}
      {% for p, c in products %}
        <tr>
          <td class="text-center">
            <input class="form-check-input row-select" type="checkbox" name="product_ids" value="{{ p.id }}">
          </td>
          <td>
            <input form="inlineEditForm" type="text" name="items[{{ p.id }}][name]" class="form-control form-control-sm" value="{{ p.name }}">
          </td>
          <td>
            <input form="inlineEditForm" type="text" name="items[{{ p.id }}][sku]" class="form-control form-control-sm" value="{{ p.sku or '' }}">
          </td>
          <td>
            <div class="input-group input-group-sm">
              <span class="input-group-text">$</span>
              <input form="inlineEditForm" type="text" name="items[{{ p.id }}][price]" class="form-control form-control-sm" value="{% if p.price %}{{ p.price }}{% endif %}" placeholder="0,00">
            </div>
          </td>
          <td class="text-center">
            <input form="inlineEditForm" class="form-check-input" type="checkbox" name="items[{{ p.id }}][in_stock]" {% if p.in_stock %}checked{% endif %}>
          </td>
          <td>
            <select form="inlineEditForm" class="form-select form-select-sm" name="items[{{ p.id }}][brand_id]">
              <option value="" {% if not p.brand_id %}selected{% endif %}>- Sin marca -</option>
              {% for b in brands %}
                <option value="{{ b.id }}" {% if p.brand_id and (p.brand_id|string) == (b.id|string) %}selected{% endif %}>{{ b.name }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <select form="inlineEditForm" class="form-select form-select-sm" name="items[{{ p.id }}][category_id]">
              <option value="" {% if not p.category_id %}selected{% endif %}>- Sin categoría -</option>
              {% for root in roots %}
                {% set children = root.children|sort(attribute='name') %}
                {% if children %}
                  <optgroup label="{{ root.name }}">
                    {% for sub in children %}
                      <option value="{{ sub.id }}" {% if p.category_id and (p.category_id|string) == (sub.id|string) %}selected{% endif %}>{{ sub.name }}</option>
                    {% endfor %}
                  </optgroup>
                {% else %}
                  <option value="{{ root.id }}" {% if p.category_id and (p.category_id|string) == (root.id|string) %}selected{% endif %}>{{ root.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </td>
          <td>
            <div class="d-flex flex-column gap-1">
              <div class="d-flex align-items-center gap-2 flex-wrap">
                {% if p.image_filename %}
                  <img src="{{ url_for('static', filename='img/products/' ~ p.image_filename) }}" alt="{{ p.name }}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: contain;">
                {% endif %}
                {% for img in p.images %}
                  <img src="{{ url_for('static', filename='img/products/' ~ img.filename) }}" alt="{{ p.name }}" class="img-thumbnail" style="width: 40px; height: 40px; object-fit: contain;">
                {% endfor %}
              </div>
              <input form="inlineEditForm" type="file" name="images_{{ p.id }}[]" accept="image/*" multiple class="form-control form-control-sm">
              <small class="text-muted">Podés seleccionar varias imágenes a la vez (máx. 10 por producto).</small>
            </div>
          </td>
          <td class="text-end">
            <div class="d-flex flex-wrap justify-content-end gap-2">
              <a class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1" href="{{ url_for('main.products_admin_edit', product_id=p.id) }}">
                <i class="bi bi-pencil-square"></i>
                Edición completa
              </a>
              <form class="d-inline" method="post" action="{{ url_for('main.products_admin_feature_toggle', product_id=p.id) }}">
                <input type="hidden" name="next" value="{{ request.full_path }}">
                {% if p.featured %}
                  <button class="btn btn-sm btn-warning" type="submit" title="Quitar de destacados">Quitar dest.</button>
                {% else %}
                  <button class="btn btn-sm btn-outline-warning" type="submit" title="Añadir a destacados">Destacar</button>
                {% endif %}
              </form>
              <form class="d-inline" method="post" action="{{ url_for('main.products_admin_delete', product_id=p.id) }}" onsubmit="return confirm('¿Eliminar este producto?');">
                <button class="btn btn-sm btn-outline-danger" type="submit">Eliminar</button>
              </form>
            </div>
          </td>
        </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="7" class="text-center text-muted">No hay productos que coincidan con la búsqueda.</td>
      </tr>
    {% endif %}
    </tbody>
  </table>

</div>

</form>

<form id="inlineEditForm" method="post" action="{{ url_for('main.products_admin_inline_update') }}" enctype="multipart/form-data">
  <input type="hidden" name="q" value="{{ q or '' }}">
  <input type="hidden" name="category_id" value="{{ category_id or '' }}">
  <input type="hidden" name="brand_id" value="{{ brand_id or '' }}">
  <input type="hidden" name="per_page" value="{{ per_page }}">
  <input type="hidden" name="page" value="{{ page }}">
</form>

{% if pages and pages > 1 %}
<nav aria-label="Paginación productos" class="d-flex justify-content-between align-items-center">
  <ul class="pagination mb-0">
    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('main.products_admin_list', q=q, category_id=category_id, brand_id=brand_id, per_page=per_page, page=page-1) }}">Anterior</a>
    </li>
    <li class="page-item disabled"><span class="page-link">Página {{ page }} de {{ pages }}</span></li>
    <li class="page-item {% if page >= pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('main.products_admin_list', q=q, category_id=category_id, brand_id=brand_id, per_page=per_page, page=page+1) }}">Siguiente</a>
    </li>
  </ul>
  <form class="d-flex align-items-center gap-2" method="get" action="{{ url_for('main.products_admin_list') }}">
    <input type="hidden" name="q" value="{{ q or '' }}">
    <input type="hidden" name="category_id" value="{{ category_id or '' }}">
    <input type="hidden" name="brand_id" value="{{ brand_id or '' }}">
    <input type="hidden" name="per_page" value="{{ per_page }}">
    <label class="mb-0">Ir a página</label>
    <input type="number" min="1" max="{{ pages }}" name="page" class="form-control form-control-sm" style="width: 90px;">
    <button class="btn btn-sm btn-outline-secondary" type="submit">Ir</button>
  </form>
</nav>
{% endif %}

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const uploadInput = document.getElementById('excelUploadInput');
    const parseBtn = document.getElementById('excelParseBtn');
    const resultsWrapper = document.getElementById('excelResults');
    const resultsBody = document.querySelector('#excelResultsTable tbody');
    const selectAllBtn = document.getElementById('excelSelectAll');
    const deselectAllBtn = document.getElementById('excelDeselectAll');
    const controls = document.getElementById('excelControls');
    const sendBtn = document.getElementById('excelSendBtn');
    const payloadInput = document.getElementById('excelPayload');
    const previewForm = document.getElementById('excelPreviewForm');
    let parsedEntries = [];
    let lastCheckedIndex = null;
    const checkboxesSelector = '#excelResultsTable tbody input[type=checkbox]';
    const getCheckboxes = () => Array.from(document.querySelectorAll(checkboxesSelector));

    const toggleSend = () => {
      const anyChecked = !!document.querySelector('#excelResultsTable tbody input[type=checkbox]:checked');
      sendBtn.disabled = !anyChecked;
    };

    const renderEntries = () => {
      if (!parsedEntries.length) {
        resultsWrapper.classList.add('d-none');
        controls.classList.add('d-none');
        sendBtn.disabled = true;
        resultsBody.innerHTML = '';
        return;
      }
      const rows = parsedEntries.map((entry, idx) => `
        <tr>
          <td><input class="form-check-input" type="checkbox" data-index="${idx}" checked></td>
          <td>${entry.code || '&mdash;'}</td>
          <td>${entry.name || '&mdash;'}</td>
        </tr>
      `).join('');
      resultsBody.innerHTML = rows;
      lastCheckedIndex = null;
      resultsWrapper.classList.remove('d-none');
      controls.classList.remove('d-none');
      sendBtn.disabled = !rows;
    };

    const parseWorkbook = (data) => {
      const workbook = XLSX.read(data, { type: 'array' });
      if (!workbook || !workbook.SheetNames.length) {
        alert('El archivo no contiene hojas válidas.');
        return [];
      }
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
      const entries = [];
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const code = (row[1] || '').toString().trim();
        const name = (row[2] || '').toString().trim();
        if (!code && !name) continue;
        entries.push({ code, name });
      }
      return entries;
    };

    parseBtn.addEventListener('click', () => {
      if (!uploadInput.files.length) {
        uploadInput.focus();
        return;
      }
      const file = uploadInput.files[0];
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = new Uint8Array(event.target.result);
          parsedEntries = parseWorkbook(data);
          if (!parsedEntries.length) {
            alert('No se encontraron productos con código y nombre en las columnas B/C.');
          }
          renderEntries();
        } catch (error) {
          console.error(error);
          alert('Ocurrió un error leyendo el Excel. Asegurate que tiene columnas B y C con datos.');
        }
      };
      reader.readAsArrayBuffer(file);
    });

    selectAllBtn.addEventListener('click', () => {
      const checkboxes = getCheckboxes();
      checkboxes.forEach(cb => cb.checked = true);
      lastCheckedIndex = checkboxes.length ? checkboxes.length - 1 : null;
      toggleSend();
    });

    deselectAllBtn.addEventListener('click', () => {
      const checkboxes = getCheckboxes();
      checkboxes.forEach(cb => cb.checked = false);
      lastCheckedIndex = null;
      toggleSend();
    });

    resultsBody.addEventListener('click', (event) => {
      const checkbox = event.target;
      if (!checkbox.matches('input[type=checkbox]')) return;
      const idx = Number(checkbox.dataset.index);
      if (Number.isNaN(idx)) return;
      if (event.shiftKey && lastCheckedIndex !== null) {
        const start = Math.min(lastCheckedIndex, idx);
        const end = Math.max(lastCheckedIndex, idx);
        const value = checkbox.checked;
        const checkboxes = getCheckboxes();
        for (let i = start; i <= end; i++) {
          const cb = checkboxes[i];
          if (cb) cb.checked = value;
        }
      }
      lastCheckedIndex = idx;
      toggleSend();
    });

    resultsBody.addEventListener('change', (event) => {
      if (event.target.matches('input[type=checkbox]')) {
        toggleSend();
      }
    });

    sendBtn.addEventListener('click', () => {
      const selected = [];
      document.querySelectorAll('#excelResultsTable tbody input[type=checkbox]').forEach((checkbox, idx) => {
        if (checkbox.checked) {
          const entry = parsedEntries[Number(checkbox.dataset.index)];
          if (entry) {
            selected.push({
              name: entry.name,
              sku: entry.code,
              price: '',
              in_stock: true,
              brand_id: '',
              category_id: '',
            });
          }
        }
      });
      if (!selected.length) {
        alert('Seleccioná al menos un producto antes de enviar.');
        return;
      }
      payloadInput.value = JSON.stringify(selected);
      previewForm.submit();
    });
  });
</script>
{% endblock %}