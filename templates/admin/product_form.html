{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3">{{ title }}</h3>
{% set cancel_href = cancel_url or url_for('main.products_admin_list') %}
{% set gallery_context = gallery_context or 'none' %}
{% set gallery_context_id = gallery_context_id or '' %}
{% set gallery_reorder_endpoint = gallery_reorder_endpoint or '' %}
<form
  id="productForm"
  method="post"
  action="{{ form_action }}"
  enctype="multipart/form-data"
  data-gallery-url-endpoint="{{ url_for('main.products_gallery_url_upload') }}"
  data-gallery-context="{{ gallery_context }}"
  data-gallery-context-id="{{ gallery_context_id }}"
  data-gallery-reorder-endpoint="{{ gallery_reorder_endpoint }}">
  <div class="row g-3">
    <div class="col-12 col-md-6">
      <label class="form-label">Nombre</label>
      <input type="text" name="name" class="form-control" value="{{ product.name if product else '' }}" required>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">SKU</label>
      <input type="text" name="sku" class="form-control" value="{{ product.sku if product and product.sku else '' }}">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Precio</label>
      <div class="input-group">
        <span class="input-group-text">$</span>
        <input type="text" name="price" class="form-control" value="{% if product and product.price %}{{ product.price|ar_number }}{% endif %}" placeholder="0,00">
      </div>
    </div>

    <div class="col-12 col-md-6">
      <label class="form-label">Categoría</label>
      <select class="form-select" name="category_id">
        <option value="" {% if not product or not product.category_id %}selected{% endif %}>- Sin categoría -</option>
        {% for root in roots %}
          {% set children = root.children|sort(attribute='name') %}
          {% if children %}
            <optgroup label="{{ root.name }}">
              {% for sub in children %}
                <option value="{{ sub.id }}" {% if product and product.category_id == sub.id %}selected{% endif %}>{{ sub.name }}</option>
              {% endfor %}
            </optgroup>
          {% else %}
            <option value="{{ root.id }}" {% if product and product.category_id == root.id %}selected{% endif %}>{{ root.name }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-6">
      <label class="form-label">Marca</label>
      <select class="form-select" name="brand_id">
        <option value="" {% if not product or not product.brand_id %}selected{% endif %}>- Sin marca -</option>
        {% for b in brands %}
          <option value="{{ b.id }}" {% if product and product.brand_id == b.id %}selected{% endif %}>{{ b.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-6 d-flex align-items-end">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="1" id="in_stock" name="in_stock" {% if not product or product.in_stock %}checked{% endif %}>
        <label class="form-check-label" for="in_stock">
          En stock
        </label>
      </div>
    </div>

    <div class="col-12">
      {% set gallery_display = gallery_display if gallery_display is defined else (product.images if product and product.images else []) %}
      {% set gallery_limit = max_gallery_images if max_gallery_images is not none else 10 %}
      {% set current_gallery = gallery_display|length %}
      {% set remaining_gallery = gallery_limit - current_gallery %}
      <div class="d-flex flex-wrap align-items-center gap-2">
        <label class="form-label mb-0">Galería (hasta {{ gallery_limit }} imágenes)</label>
        {% if gallery_display %}
          <button type="submit" class="btn btn-outline-danger btn-sm" name="clear_gallery" value="1" id="clearGalleryBtn" data-clear-gallery="true">Quitar todas</button>
        {% endif %}
      </div>
      <div class="form-text text-muted mb-1">La primera imagen de la galería se mostrará como principal del producto.</div>
      <input type="file" name="gallery_images" accept="image/*" multiple class="form-control" data-gallery-input="true" {% if remaining_gallery <= 0 %}disabled{% endif %}>
      <div id="galleryPreview" class="gallery-preview-grid d-none mt-2"></div>
      <div class="form-text{% if remaining_gallery <= 0 %} text-danger{% endif %}">
        {% if remaining_gallery <= 0 %}
          Ya alcanzaste el límite de {{ gallery_limit }} imágenes. Eliminá alguna antes de subir nuevas.
        {% else %}
          Podés subir hasta {{ remaining_gallery }} imagen{% if remaining_gallery != 1 %}es{% endif %} adicionales (máximo {{ gallery_limit }}).
        {% endif %}
      </div>
        {% set posted_gallery_urls = request.form.getlist('gallery_image_urls[]') if request.method == 'POST' else [] %}
        <div class="mt-3">
          <label class="form-label">Cargar imágenes desde URL (hasta {{ gallery_limit }} enlaces)</label>
          <div class="form-text text-muted mb-2">Pegá enlaces directos a JPG/PNG/WebP. Presioná Enter para intentar la carga inmediata; si la imagen no se detecta se mostrará una advertencia.</div>
          <div class="gallery-url-grid">
            {% set url_value = posted_gallery_urls[0] if posted_gallery_urls else '' %}
            <input type="url" name="gallery_image_urls[]" class="form-control gallery-url-input mb-2" placeholder="https://ejemplo.com/imagen.jpg" value="{{ url_value }}" data-allow-enter="true">
          </div>
          <div class="form-text">Las casillas vacías se ignoran automáticamente.</div>
          <div id="galleryUrlStatus" class="mt-2"></div>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-3 gallery-thumb-pool{% if not gallery_display %} d-none{% endif %}" id="currentGalleryThumbnails" data-gallery-sortable="true">
          {% if gallery_display %}
            {% for img in gallery_display %}
              <div class="gallery-thumb-card" draggable="true" data-gallery-sort-id="{{ img.image_id or img.filename }}">
                <div class="ratio ratio-1x1 gallery-thumb-img-wrapper">
                  <img src="{{ url_for('static', filename='img/products/' + img.filename) }}" alt="{{ product.name }}" class="img-fluid gallery-thumb-img">
                </div>
                {% if img.remove_token %}
                  <button type="submit" class="btn btn-outline-danger btn-sm w-100" name="remove_gallery_token" value="{{ img.remove_token }}" data-gallery-remove="true">Quitar</button>
                {% endif %}
              </div>
            {% endfor %}
          {% endif %}
        </div>
        <div class="form-text" id="currentGalleryHelp">Arrastrá y soltá las imágenes para reordenarlas (la primera imagen será la principal). También podés usar "Quitar" para remover alguna.</div>
    </div>

    <div class="col-12">
      <label class="form-label">Descripción corta</label>
      <input type="text" name="short_desc" class="form-control" value="{{ product.short_desc if product and product.short_desc else '' }}" maxlength="300">
    </div>

    <div class="col-12">
      <label class="form-label">Descripción larga</label>
      <textarea name="long_desc" class="form-control" rows="6">{{ product.long_desc if product and product.long_desc else '' }}</textarea>
    </div>
  </div>

  <div class="mt-4 d-flex flex-wrap gap-2 align-items-center">
    <a class="btn btn-outline-secondary" href="{{ cancel_href }}">Cancelar</a>
    <button class="btn btn-primary" type="submit">Guardar</button>
    {% if product and product.id %}
      <button class="btn btn-outline-danger ms-md-auto" type="submit" formaction="{{ url_for('main.products_admin_delete', product_id=product.id) }}" formmethod="post" formnovalidate data-delete-product="true">Eliminar producto</button>
    {% endif %}
  </div>
</form>
<div class="image-upload-overlay d-none" id="imageUploadOverlay">
  <div class="overlay-box">
    <div class="spinner-border text-light" role="status"></div>
    <p class="mb-0">Subiendo imágenes...</p>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  var form = document.getElementById('productForm');
  if (!form) return;
  form.addEventListener('keydown', function (ev) {
    if (ev.key !== 'Enter') return;
    var tag = ev.target && ev.target.tagName;
    if (!tag) return;
    if (tag === 'TEXTAREA') return; // permitir saltos de línea
    var type = ev.target.getAttribute('type');
    if (tag === 'BUTTON' && type === 'submit') return;
    if (tag === 'INPUT' && type === 'submit') return;
    ev.preventDefault();
  });
});
</script>
{% endblock %}